#!/usr/bin/env python
#=========================================================================
# ece4750-lab-admin [options]
#=========================================================================
#
#  -v --verbose                           Turn on verbose mode
#  -h --help                              Display this message
#  -s --status                            Check current status
#     --join-class [GitHub ID]            Update your GitHub ID
#     --make-request [request] [argument]
#                                         Make a request, choice =
#                                           ( group-create, group-join,
#                                             group-approve, group-leave )
#     --cancel-request                    Cancel pending request
#
# ece4750 lab management tool. Before makeing any request, please use
# --join-class [GitHub ID] command to submit your GitHub ID. This is
# required for this class.
#

# Author : Khalid Al-Hawaj
# Date   : August 25, 2017
#
# Based off of Moyang's script. Though, this was heavly changed to adapt
# to a proper inter-process communication rather than depending on shared
# file reads and writes

import argparse
import sys
import os
import datetime
import json
import getpass
import socket

#-------------------------------------------------------------------------
# Command Line Processing
#-------------------------------------------------------------------------

class ArgumentParserWithCustomError(argparse.ArgumentParser):
  def error( self, msg = '' ):
    if ( msg ): print('\n ERROR: %s' % msg)
    print('')
    file = open( sys.argv[0] )
    for ( lineno, line ) in enumerate( file ):
      if ( line[0] != '#' ): sys.exit(msg != '')
      if ( (lineno == 2) or (lineno >= 4) ): print( line[1:].rstrip('\n') )

def parse_cmdline():
  p = ArgumentParserWithCustomError( add_help=False )

  p.add_argument( '-v', '--verbose',         action='store_true'  )
  p.add_argument( '-h', '--help',            action='store_true'  )
  p.add_argument( '-s', '--status',          action='store_true'  )
  p.add_argument(       '--join-class',      default=''           )

  p.add_argument(       '--server',          nargs = '+'          )
  p.add_argument(       '--github',          nargs = '+'          )
  p.add_argument(       '--group',           nargs = '+'          )
  p.add_argument(       '--students',        nargs = '+'          )

  opts = p.parse_args()
  if opts.help: p.error()
  return opts

opts = parse_cmdline()

#-------------------------------------------------------------------------
# Constants
#-------------------------------------------------------------------------

from global_config import global_config

gConfigs = global_config()

#-------------------------------------------------------------------------
# Connection utilities
#-------------------------------------------------------------------------

def send_data ( sock, data, drastic = True ):

  # Assume data is ASCII
  length = len( data )
  new_data = '{:04d}{}'.format( length, data )

  # Send the packet
  try:
    sock.sendall( new_data.encode() )
  except:
    print('ERROR: cannot send data')
    if drastic:
      sock.close()
      quit ( -1 )
    else:
      pass

def recv_data ( sock, drastic = False ):

  # Again, data is text :)
  data = None

  try:
    # Get packet length
    tmp = sock.recv( 4 ).decode()
    length = int( tmp )
    data = sock.recv( length ).decode()
  except:
    if drastic:
      sock.close()
      quit ( -1 )
    else:
      pass

  return data

#-------------------------------------------------------------------------
# Socket
#-------------------------------------------------------------------------

# Connect to a service in the same server it is coming from
sock = None

try:
  sock = socket.create_connection(( gConfigs.server_addr, gConfigs.server_port ))
except:
  print('ERROR: cannot connect to server')
  quit ( -1 )

#-------------------------------------------------------------------------
# Specify request
#-------------------------------------------------------------------------

res_raw = None

if opts.status:
  # Send request
  req = 'status'
  send_data( sock, req )

  # Get response
  res_raw = recv_data( sock )

if opts.join_class:
  # Send request
  req = 'github\nset\n{}'.format( opts.join_class )
  send_data( sock, req )

  # Get response
  res_raw = recv_data( sock )

if opts.github:
  # Get command and argument
  cmd = opts.github[0]
  args = ''
  if len( opts.github ) > 1:
    args = opts.github[1]

  # Send request
  req = 'github\n{}\n{}'.format( cmd, args )
  send_data( sock, req )

  # Get resposne
  res_raw = recv_data( sock )

if opts.group:
  # Get command and argument
  cmd = opts.group[0]
  args = ''
  if len( opts.group ) > 1:
    args = '\n'.join( opts.group[1:] )

  # Send request
  req = 'group\n{}\n{}'.format( cmd, args )
  send_data( sock, req )

  # Get resposne
  res_raw = recv_data( sock )

if opts.server:
  # Get command and argument
  cmd = opts.server[0]
  args = ''
  if len( opts.server ) > 1:
    args = '\n'.join( opts.server[1:] )

  if cmd == 'setup':
    print('')
    username = input          ('  Username : ')
    pwd      = getpass.getpass('  Password : ')
    print('')

    # Arguments
    args = '{}\n{}'.format( username, pwd )

  # Send request
  req = 'server\n{}\n{}'.format( cmd, args )
  send_data( sock, req )

  # Get resposne
  res_raw = recv_data( sock )

if opts.students:
  # Get command and argument
  cmd = opts.students[0]
  args = ''
  if len( opts.students ) > 1:
    args = '\n'.join( opts.students[1:] )

  # Send request
  req = 'students\n{}\n{}'.format( cmd, args )
  send_data( sock, req )

  # Get resposne
  res_raw = recv_data( sock )

#-------------------------------------------------------------------------
# Finish up
#-------------------------------------------------------------------------

# Clean up connections
sock.close()

# Parse the response
if res_raw == None:
  res_raw = '-6' + '\n' + 'Error parsing the supplied arguments!'

response  = res_raw.split( '\n' )

code = -1
try:
  code = int( response[0] )
except:
  pass

ret     = code
message = '\n'.join(response[1:])

if ret != 0:
  print('ERROR executing the specified command (code {})'.format( ret ))
  print('')

print('{}'.format( message ))
print('')

quit ( ret )
