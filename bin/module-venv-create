#!/bin/bash
#=========================================================================
# module-venv-create [options] venv-name
#=========================================================================
#
#  -h  Display this message
#  -v  Verbose mode
#
# Create a new Python virtual environment and also create a
# corresponding environment module to enable loading/unloading this
# virtual environment.
#
# Author : Christopher Batten
# Date   : August 16, 2024

set -e

#-------------------------------------------------------------------------
# Command line parsing
#-------------------------------------------------------------------------

function usage
{
  echo ""
  sed -n '3p' $0 | sed -e 's/#//'
  sed -n '5,/^$/p' $0 | sed -e 's/#//'
  exit 1
}

verbose=no
while getopts "hvr" OPTION; do
  case $OPTION in
    v)   verbose=yes ;;
    h|?) usage ;;
  esac
done

if [ $# -eq 0 ]; then
  echo ""
  echo " ERROR: No virtual environment name given!"
  echo ""
  exit 1
fi

#-------------------------------------------------------------------------
# Main
#-------------------------------------------------------------------------

# Make sure python is available

if ! command -v python3 >/dev/null 2>&1; then
  echo ""
  echo " ERROR: python3 is not found!"
  echo ""
  exit 1
fi

# Create venv name assuming not using python environment module

python_version=$(python3 --version 2>&1)

if [[ ! $python_version == *"PyPy"* ]]; then
  python_vernum=$(echo "$python_version" | sed -n 's/^Python \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
  venv_name="py${python_vernum}"
fi

if [[ $python_version == *"PyPy"* ]]; then
  python_vernum=$(echo "$python_version" | sed -n 's/^Python \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
  pypy_vernum=$(echo "$python_version" | sed -n 's/.*PyPy \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
  python_vernum="${python_vernum}-v${pypy_vernum}"
  venv_name="pypy${python_vernum}"
fi

# Recreate venv name if we are using a python environment module

prereq_str=""

if module is-loaded python; then
  python_module_info=$(module info-loaded python)
  python_vernum=${python_module_info#*/}
  prereq_str="prereq   ${python_module_info}"
  venv_name="py${python_vernum}"
fi

if module is-loaded pypy; then
  pypy_module_info=$(module info-loaded pypy)
  python_vernum=${pypy_module_info#*/}
  prereq_str="prereq   ${pypy_module_info}"
  venv_name="pypy${python_vernum}"
fi

# Make sure the venv directory exists

mkdir -p ${ECE6745_INSTALL}/venvs

# Create the virtual environment

python3 -m venv ${ECE6745_INSTALL}/venvs/${venv_name}-$1

# Create the corresponding environment module

mkdir -p ${ECE6745_INSTALL}/modules/venvs
cd ${ECE6745_INSTALL}/modules/venvs
cat > ${venv_name}-$1 \
<<END
#%Module1.0

conflict venvs
${prereq_str}

unsetenv     PYTHONHOME
setenv       VIRTUAL_ENV /classes/ece6745/install/venvs/${venv_name}-$1
prepend-path PATH        /classes/ece6745/install/venvs/${venv_name}-$1/bin

END

# Output name of new environment module

echo "created new environment module: venvs/${venv_name}-$1"

