#!/bin/bash
#=========================================================================
# tinyflow-netlist2svg top-module-name verilog-file1 verilog-file2 ...
#=========================================================================
#
#  -h  Display this message
#  -v  Verbose mode
#
# Concatenate the verilog files, use Yosys to create a JSON netlist
# file, set the types of the standard cells, and use netlistsvg to
# generate a netlist SVG file.
#
# Author : Christopher Batten
# Date   : February 11, 2025

set -e

#-------------------------------------------------------------------------
# Command line parsing
#-------------------------------------------------------------------------

function usage
{
  echo ""
  sed -n '3p' $0 | sed -e 's/#//'
  sed -n '5,/^$/p' $0 | sed -e 's/#//'
  exit 1
}

verbose=no
while getopts "hvr" OPTION; do
  case $OPTION in
    v)   verbose=yes ;;
    h|?) usage ;;
  esac
done

if [ $# -eq 0 ]; then
  echo ""
  echo " ERROR: No arguments given!"
  echo ""
  exit 1
fi

#-------------------------------------------------------------------------
# Main
#-------------------------------------------------------------------------

# Concatenate Verilog files
cat $2 $3 $4 $5 $6 > $1-concat.v

# Use Yosys to generate JSON

yosys --quiet --commands "
 read_verilog -sv $1-concat.v;
 hierarchy -top $1;
 write_json $1-concat.json;
"

# Set type appropriately for standard cells

sed -e 's/"type": "BUFX1"/"type":   "$_BUX_"/g' \
    -e 's/"type": "INVX1"/"type":   "$_NOT_"/g' \
    -e 's/"type": "AND2X1"/"type":  "$_AND_"/g' \
    -e 's/"type": "OR2X1"/"type":   "$_OR_"/g' \
    -e 's/"type": "XOR2X1"/"type":  "$_XOR_"/g' \
    -e 's/"type": "NAND2X1"/"type": "$_NAND_"/g' \
    -e 's/"type": "NOR2X1"/"type":  "$_NOR_"/g' \
    -e 's/"type": "XNOR2X1"/"type": "$_XNOR_"/g' \
    -e 's/"type": "AOI21X1"/"type": "$_AOI3_"/g' \
    -e 's/"type": "AOI22X1"/"type": "$_AOI4_"/g' \
    -e 's/"type": "OAI21X1"/"type": "$_OAI3_"/g' \
    -e 's/"type": "OAI22X1"/"type": "$_OAI4_"/g' \
    -e 's/"type": "MUX2X1"/"type":  "$_MUX_"/g' \
    $1-concat.json > $1-concat-postprocessed.json

# Use netlistsvg to generate SVG

netlistsvg -o $1-temp.svg $1-concat-postprocessed.json

# Make SVG have a white background

sed -e 's@</style>@</style><rect width="100%" height="100%" fill="white"/>@' \
    $1-temp.svg > $1.svg

# Cleanup

rm -rf $1-concat.v
rm -rf $1-concat.json
rm -rf $1-concat-postprocessed.json
rm -rf $1-temp.svg
