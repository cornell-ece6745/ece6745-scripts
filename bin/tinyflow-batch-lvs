#!/usr/bin/env python3
#=========================================================================
# Wrapper script for running batch LVS using KLayout
#=========================================================================
# Usage: tinyflow-batch-lvs <input.gds> <schematic.sp>
#=========================================================================
# Authors : Vayun Tiwari
# Date    : January 2026

import subprocess
import sys
import os
from pathlib import Path

OUTPUT_DIR = "./lvs_results/"
EXTRACTION_DIR = "./rcx-results/"

SCRIPT_DIR = Path(__file__).parent.absolute()
BATCH_LVS_RB = SCRIPT_DIR / "../share/tinyflow-batch-lvs/batch-lvs.rb"
LVS_DECK = SCRIPT_DIR / "../share/tinyflow-batch-lvs/batch-cell-lvs.lylvs"

def main():
    if len(sys.argv) != 3:
        print(f"Usage: {sys.argv[0]} <input.gds> <schematic.sp>", file=sys.stderr)
        sys.exit(1)

    input_path = Path(sys.argv[1]).resolve()
    if not input_path.exists():
        print(f"Error: Input GDS file not found at {input_path}", file=sys.stderr)
        sys.exit(1)

    schematic_path = Path(sys.argv[2]).resolve()
    if not schematic_path.exists():
        print(f"Error: Schematic file not found at {schematic_path}", file=sys.stderr)
        sys.exit(1)

    if not BATCH_LVS_RB.exists():
        print(f"Error: batch-lvs.rb not found at {BATCH_LVS_RB}", file=sys.stderr)
        sys.exit(1)

    if not LVS_DECK.exists():
        print(f"Error: LVS rule deck not found at {LVS_DECK}", file=sys.stderr)
        sys.exit(1)

    klayout_cmd = os.environ.get('KLAYOUT', 'klayout')
    klayout_ece6745_path = '/classes/ece6745/install/pkgs/klayout-0.30.5/bin/klayout'

    if klayout_cmd == 'klayout':
        import shutil
        if not shutil.which('klayout') and os.path.exists(klayout_ece6745_path):
            klayout_cmd = klayout_ece6745_path

    cmd = [
        klayout_cmd,
        "-b",
        "-r", str(BATCH_LVS_RB),
        "-rd", f"input={input_path}",
        "-rd", f"schematic={schematic_path}",
        "-rd", f"lvs={LVS_DECK}",
        "-rd", f"output_dir={OUTPUT_DIR}",
        "-rd", f"extraction_dir={EXTRACTION_DIR}"
    ]

    try:
        result = subprocess.run(cmd, check=False)
        sys.exit(result.returncode)
    except FileNotFoundError:
        print("Error: 'klayout' command not found. Make sure KLayout is installed and in your PATH.", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"Error running klayout: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
