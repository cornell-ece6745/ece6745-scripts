#!/usr/bin/env python
#=========================================================================
# ece4750-travis-status [options]
#=========================================================================
#
#  -h --help         Display this message
#  -v --verbose      Verbose mode
#     --lab          Which lab to display status for
#     --branch       Which branch to display status for
#     --tail <n>     Display tail of each build log
#
# This script will use the TravisCI command line client to display the
# current build status of all groups. By default it checks the master
# branch.
#
# Author : Christopher Batten
# Date   : September 12, 2015
#

import argparse
import sys
import re
import os
import sys
import shutil
import glob
import subprocess
import string
import shlex
import json
import termcolor

#-------------------------------------------------------------------------
# Command line processing
#-------------------------------------------------------------------------

class ArgumentParserWithCustomError(argparse.ArgumentParser):
  def error( self, msg = "" ):
    if ( msg ): print("\n ERROR: %s" % msg)
    print("")
    file = open( sys.argv[0] )
    for ( lineno, line ) in enumerate( file ):
      if ( line[0] != '#' ): sys.exit(msg != "")
      if ( (lineno == 2) or (lineno >= 4) ): print( line[1:].rstrip("\n") )

def parse_cmdline():
  p = ArgumentParserWithCustomError( add_help=False )
  p.add_argument( "-v", "--verbose",      action="store_true" )
  p.add_argument( "-h", "--help",         action="store_true" )
  p.add_argument(       "--branch",       default="master"    )
  p.add_argument(       "--lab",          default=None        )
  p.add_argument(       "--tail",         default=None        )
  opts = p.parse_args()
  if opts.help: p.error()
  return opts

#-------------------------------------------------------------------------
# Helpers
#-------------------------------------------------------------------------

# String interpolation

def S( s ):
  frame = sys._getframe(1)
  template = string.Template(s)
  return template.substitute(**frame.f_locals)

# Assemble path

def P( *args ):
  return os.path.join( *args )

# Run command with string interpolation

def run( cmd ):
  frame = sys._getframe(1)
  template = string.Template(cmd)
  cmd_ = template.substitute(**frame.f_locals)
  vprint( " - run:", cmd_ )

  try:

    result = subprocess.check_output( cmd_, shell=True ).strip()

  except subprocess.CalledProcessError as e:
    print "\n ERROR: running the following command\n {} \n".format( ' '.join(e.cmd) )
    print e.output
    exit(1)

  print result
  return result

# Quiet run

def runq( cmd ):
  frame = sys._getframe(1)
  template = string.Template(cmd)
  cmd_ = template.substitute(**frame.f_locals)
  vprint( " - run:", cmd_ )

  try:

    result = subprocess.check_output( cmd_, shell=True ).strip()

  except subprocess.CalledProcessError as e:
    print "\n ERROR: running command \n"
    print e.cmd
    print e.output
    exit(1)

  return result

# Run and return exit status

def run_test( cmd ):
  frame = sys._getframe(1)
  template = string.Template(cmd)
  cmd_ = template.substitute(**frame.f_locals)
  vprint( " - run test:", cmd_ )
  return subprocess.check_call( cmd_, shell=True ).strip()

#-------------------------------------------------------------------------
# Verbose print
#-------------------------------------------------------------------------

verbose = False
def vprint( msg, value=None ):
  if verbose:
    if value != None:
      print msg, value
    else:
      print msg

#-------------------------------------------------------------------------
# Lab group numbers
#-------------------------------------------------------------------------
# Hard code how many groups completed each lab

num_groups = [
  29, # lab 1
  29, # lab 2
  29, # lab 3
  29, # lab 4
]

#-------------------------------------------------------------------------
# get_status
#-------------------------------------------------------------------------

def get_status( group_num_str, branch, short=False ):

  status_line = runq(
    "travis history"
    " --no-interactive"
    " --limit  1"
    " --branch ${branch}"
    " --repo   cornell-ece4750/lab-group${group_num_str}" )

  status = re.split( ' |:', status_line )[1]
  if short:
    if status == "passed":
      status_colored = termcolor.colored(".     ","green")
    elif status == "failed":
      status_colored = termcolor.colored("failed","red")
    elif status == "errored":
      status_colored = termcolor.colored("error ","red")
    elif status == "created":
      status_colored = termcolor.colored("queued","yellow")
    elif status == "started":
      status_colored = termcolor.colored("queued","yellow")
    else:
      status_colored = "?     "
  else:
    if status == "passed":
      status_colored = termcolor.colored("passed","green")
    elif status == "failed":
      status_colored = termcolor.colored("failed","red")
    elif status == "errored":
      status_colored = termcolor.colored("error ","red")
    elif status == "created":
      status_colored = termcolor.colored("queued","yellow")
    elif status == "started":
      status_colored = termcolor.colored("queued","yellow")
    else:
      status_colored = status

  return status_colored

#-------------------------------------------------------------------------
# print_branch_status
#-------------------------------------------------------------------------

def print_branch_status( branch, tail ):

  with open("/classes/ece4750/staff/database/group-info.json") as data_file:
    data = json.load(data_file)

  group_num_strs = []
  for group_num,group_members in data.iteritems():
    if group_members:
      group_num_strs.append( group_num.zfill(2) )

  for group_num_str in sorted(group_num_strs):
    status = get_status( group_num_str, branch )

    if not tail:
      print S(" - lab-group${group_num_str} : ${status}")

    else:
      print "-"*74
      print S("lab-group${group_num_str} : ${status}")
      print "-"*74
      print ""

      run(
        "travis logs ${branch}"
        " --insecure"
        " --repo cornell-ece4750/lab-group${group_num_str}"
        " | tail -${tail}" )

      print ""

#-------------------------------------------------------------------------
# print_lab_status
#-------------------------------------------------------------------------

def print_lab_status( lab ):

  group_num_strs = []
  for i in range(1,num_groups[int(lab)-1]+1):
    group_num_strs.append( str(i).zfill(2) )

  from os.path import expanduser
  home = expanduser("~")

  tmp_dir=S("${home}/tmp/misc/ece4750-travis-status")
  if os.path.lexists( tmp_dir ):
    shutil.rmtree( tmp_dir )
  os.makedirs( tmp_dir )

  print S("               |        |        | pull   | pull    ")
  print S("               | submit | graded | req    | req     ")
  print S("               | status | status | status | active? ")
  print S(" --------------+--------+--------+--------+---------")

  for group_num_str in sorted(group_num_strs):

    print S("  lab-group${group_num_str}  |"),
    sys.stdout.flush()

    branch = S("lab${lab}-submission")
    status = get_status( group_num_str, branch, short=True )
    print status+' |',
    sys.stdout.flush()

    branch = S("lab${lab}-staff-tests")
    status = get_status( group_num_str, branch, short=True )
    print status+' |',
    sys.stdout.flush()

    branch = S("lab${lab}-grading")
    status = get_status( group_num_str, branch, short=True )
    print status+' |',
    sys.stdout.flush()

    N = group_num_str
    os.chdir( tmp_dir )
    runq( "git clone --quiet git@github.com:cornell-ece4750/lab-group${N}" )
    os.chdir( S("${tmp_dir}/lab-group${group_num_str}") )
    runq( "git checkout --quiet lab${lab}-grading" )
    result = runq( "git log lab${lab}-staff-tests...lab${lab}-grading" )

    if result == "":
      print "."
    else:
      print "yes"

    os.chdir( tmp_dir )
    shutil.rmtree( S("${tmp_dir}/lab-group${group_num_str}") )

#-------------------------------------------------------------------------
# Main
#-------------------------------------------------------------------------

def main():

  opts = parse_cmdline()

  global verbose
  verbose = opts.verbose

  print ""

  if not opts.lab:
    print_branch_status( opts.branch, opts.tail )

  else:
    print_lab_status( opts.lab )

  print ""

main()

